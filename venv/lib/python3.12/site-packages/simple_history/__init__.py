"""Compatibility shim for environments missing ``pkg_resources``.

In Python 3.12 the distutils-based ``pkg_resources`` module is removed from the
standard library.  ``django-simple-history`` 3.0.0 imports it unconditionally
which breaks project startup on that interpreter.  We provide a very small
fallback using ``importlib.metadata`` so the package can still query its own
version without forcing an immediate dependency upgrade.
"""

try:
    from pkg_resources import DistributionNotFound, get_distribution
except ImportError:  # Python 3.12+ has no distutils/pkg_resources
    from importlib import metadata

    class DistributionNotFound(Exception):
        pass

    def get_distribution(name):
        try:
            return metadata.version(name)
        except metadata.PackageNotFoundError:  # type: ignore[attr-defined]
            raise DistributionNotFound


try:
    __version__ = get_distribution(__name__).version
except DistributionNotFound:
    # package is not installed
    pass


def register(
    model,
    app=None,
    manager_name="history",
    records_class=None,
    table_name=None,
    **records_config,
):
    """
    Create historical model for `model` and attach history manager to `model`.

    Keyword arguments:
    app -- App to install historical model into (defaults to model.__module__)
    manager_name -- class attribute name to use for historical manager
    records_class -- class to use for history relation (defaults to
        HistoricalRecords)
    table_name -- Custom name for history table (defaults to
        'APPNAME_historicalMODELNAME')

    This method should be used as an alternative to attaching an
    `HistoricalManager` instance directly to `model`.
    """
    from . import models

    if records_class is None:
        records_class = models.HistoricalRecords

    records = records_class(**records_config)
    records.manager_name = manager_name
    records.table_name = table_name
    records.module = app and ("%s.models" % app) or model.__module__
    records.cls = model
    records.add_extra_methods(model)
    records.finalize(model)
